<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="my-code/flow-style.css" rel="stylesheet">
    <!--辞書のサイズが小さいものを選択-->
</head>
<body style="height:100%;">
    <form id="searchbox-form">
       <input placeholder="言語モデルを使った検索" id="searchbox">
    </form>
    <hr>
    <form id="visitor-form">
        属性から自動選択
        <br>
        <select id="attribute1">
          <option value="a">ゲームを見たい</option>
          <option value="b">音楽を見たい</option>
          <option value="b">絵をみたい</option>
          <option value="b">プログラムをみたい</option>
        </select>
        <br>
        <select id="attribute2">
          <option value="a">実用性</option>
          <option value="b">雰囲気</option>
        </select>
    </form>
    <span>このセクションは自動生成されています。</span>
    
    <div class="page">
        <div id="flow-container" class="container-base flow-list-container">
            <!--<img src="./a8ei.png">-->
        </div>
    </div>

    <div id="works-container" style="display: flex;flex-wrap: wrap;height:100%;">
        <div style="background:red; width: 33%; height: 100%; flex: 1; min-width: 33vh;width:33vw;">
            Art(Music, Illust)
            <img src="my-works/for-search/image2.png">
        </div>
        <div style="background:red; width: 33%; height: 100%; flex: 1; min-width: 33vh;width:33vw;">
            Programing 
        </div>
        <div style="background:red; width: 33%; height: 100%; flex: 1; min-width: 33vh;width:33vw;">
            Other
        </div>
    </div>
    
    <style>
        #works-container img {
            max-width: 100%;
    }
    </style>
    <script src="other-author-lib/p5js/perlinnoise.js"></script>
    <script src="my-code/flow.js"></script>
    <script type="module">
        import { pipeline } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1/dist/transformers.min.js";

        const pipe = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2');

        //const segmenter = new TinySegmenter();
        const searchBoxForm = document.getElementById("searchbox-form");
        const searchBox = document.getElementById("searchbox");
        

        /*もしかしたら今後AIの登場でスペース区切りの検索に慣れてない人も出てくるかもなので分かち書きに変換したうえで分割する*/
        
        const candidate = await Promise.all([
            ["海と人の暗い雰囲気の絵",         
                new Item(
                    {
                       "label": "絵",
                       "image": "my-works/content/ko.png",
                       "stack": ["アクリル画", "デジタル絵", "(レタリング)", "最近描いてない"],
                       "description": "飛行機"
                    }
                ),
            ],
            ["キャラクター CG 3Dモデル 写真", 
                new Item(
                    {
                       "label": "絵",
                       "image": "my-works/content/ko.png",
                       "stack": ["アクリル画", "デジタル絵", "(レタリング)", "最近描いてない"],
                       "description": "飛行機"
                    }
                ),
            ],
            ["チャットボット ツール プログラム",
                new Item(
                    {
                        "label": "SPAM防止BOT",
                        "video": "my-works/content/chatbot.mp4",
                        "stack": ["NodeJS", "DiscordJS"],
                        "context": 
                        "スパム防止機能：\n"+
                        "単語数と文字数の比に言語ごとに特徴がある気がしたので、その値などを使ってにスパムかどうかを判定する機能を作りました。"
                    }
                )
            ],
            ["ウェブアプリケーション",
                new Item(
                    {
                        "label": "ウェブアプリケーション",
                        "video": "my-works/content/memolive-app.mp4",
                        "stack": ["JS", "TS", "SCSS", "CSS", "HTML", "React"],
                        "description": "いろいろなボックスを自由に並べたり入れ子状に組み合わせてデザインできる共同編集可能なノートアプリケーション"
                    }
                )
            ],
            ["コーネルボックス CG 大域照明モデル リムナルスペース",
                new Item(
                    {
                        "label": "pyOpenGL",
                        "movie": "",
                        "stack": ["Blender", "pyOpenGL", "Shader", "p5.js", "ShaderLab", "post-process", "Unity", "ゲーム開発"],
                        "description": "-- -- --"
                    }
                )
            ]
        ].map(async(v)=>[(await pipe(v[0], {pooling: 'mean', normalize: true})).data, ...v.slice(1)]));
        
        searchBoxForm.addEventListener('submit', (e)=>{
            e.preventDefault();
            (async()=>{
                const output = await pipe(searchBox.value, { pooling: 'mean', normalize: true });
                console.log(output.data);
                //const splitted = searchBox.value.split(/\s/).reduce((res,v)=>[...segmenter.segment(v), ...res],[]);
                let target = candidate.map(c=>[getCosineWithouNormalize(c[0],output.data), ...c.slice(1)])
                target.sort((a,b)=>b[0] - a[0]);
                //console.log(target, target.map(t=>t[1]));
                const flow = new Items(noise, ...target.map(t=>t[1]));
                flow.display(document.getElementById("flow-container"));
            })();
        });

        function getCosineWithouNormalize(a, b) {
            //console.log(a.reduce((res,v,i)=>res + v*b[i],0))
            return a.reduce((res,v,i)=>res + v*b[i],0);
        }

        function getCosine(a, b) {
            return a.reduce((res,v,i)=>res + v*b[i],0)/(
                a.reduce((res,v)=>res+v**2,0)**0.5 * b.reduce((res,v)=>res+v**2,0)**0.5
            );
        }
    </script>
</body>
</html>