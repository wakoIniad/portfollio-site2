<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!--辞書のサイズが小さいものを選択-->
    <!--<script src="https://cdn.jsdelivr.net/npm/tiny-segmenter@0.2.0/dist/tiny-segmenter-0.2.0.min.js"></script>
    <script src="other-author-lib/tiny-segmenter@0.2.0/tiny-segmenter-0.2.0.js"></script>-->
</head>
<body style="height:100%;">
    <form id="searchbox-form">
       <input placeholder="言語モデルを使った検索" id="searchbox">
    </form>
    <!--<script type="module" src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1/dist/transformers.min.js"></script>-->
    <script type="module">
        import { pipeline } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1/dist/transformers.min.js";

        // ミニLMモデルの読み込み (初回はCDNからダウンロードされる)
        const pipe = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2');

        const segmenter = new TinySegmenter();
        const searchBoxForm = document.getElementById("searchbox-form");
        const searchBox = document.getElementById("searchbox");
        

        /*もしかしたら今後AIの登場でスペース区切りの検索に慣れてない人も出てくるかもなので分かち書きに変換したうえで分割する*/
        
        const candidate = await Promise.all([
            ["海 なんで", "pic/sea.png"],
            ["雪 木", "pic/puddl.png"],
        ].map(async(v)=>[...v, (await pipe(v[0], {pooling: 'mean', normalize: true})).data]));

        searchBoxForm.addEventListener('submit', (e)=>{
            e.preventDefault();
            (async()=>{
                const output = await pipe(searchBox.value, { pooling: 'mean', normalize: true });
                console.log(output.data);
                //const splitted = searchBox.value.split(/\s/).reduce((res,v)=>[...segmenter.segment(v), ...res],[]);
                let target = candidate.map(c=>[c[0],c[1],getCosineWithouNormalize(c[2],output.data)])
                target.sort((a,b)=>b[2] - a[2]);
                console.log(target);
            })();
        });

        function getCosineWithouNormalize(a, b) {
            //console.log(a.reduce((res,v,i)=>res + v*b[i],0))
            return a.reduce((res,v,i)=>res + v*b[i],0);
        }

        function getCosine(a, b) {
            return a.reduce((res,v,i)=>res + v*b[i],0)/(
                a.reduce((res,v)=>res+v**2,0)**0.5 * b.reduce((res,v)=>res+v**2,0)**0.5
            );
        }
    </script>
    <div>ランダム毎カテゴリ</div>
    <div style="display: flex;flex-wrap: wrap;height:100%;">
        <div style="background:red; width: 33%; height: 100%; flex: 1; min-width: 33vh;width:33vw;">Art(Music, Illust)</div>
        <div style="background:red; width: 33%; height: 100%; flex: 1; min-width: 33vh;width:33vw;">Programing </div>
        <div style="background:red; width: 33%; height: 100%; flex: 1; min-width: 33vh;width:33vw;">Other</div>
    </div>
    <div>
        <div class="絵 海"></div>
    </div>
</body>
</html>