<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!--辞書のサイズが小さいものを選択-->
</head>
<body style="height:100%;">
    <form id="searchbox-form">
       <input placeholder="言語モデルを使った検索" id="searchbox">
    </form>
    <hr>
    <form id="visitor-form">
        属性から自動選択
        <br>
        <select id="attribute1">
          <option value="a">ゲームを見たい</option>
          <option value="b">音楽を見たい</option>
          <option value="b">絵をみたい</option>
          <option value="b">プログラムをみたい</option>
        </select>
        <br>
        <select id="attribute2">
          <option value="a">実用性</option>
          <option value="b">雰囲気</option>
        </select>
    </form>
    <span>このセクションは自動生成されています。</span>
    <div id="works-container" style="display: flex;flex-wrap: wrap;height:100%;">
        <div style="background:red; width: 33%; height: 100%; flex: 1; min-width: 33vh;width:33vw;">
            Art(Music, Illust)
            <img src="my-works/for-search/image2.png">
        </div>
        <div style="background:red; width: 33%; height: 100%; flex: 1; min-width: 33vh;width:33vw;">
            Programing 
        </div>
        <div style="background:red; width: 33%; height: 100%; flex: 1; min-width: 33vh;width:33vw;">
            Other
        </div>
    </div>
    
    <style>
        #works-container img {
            max-width: 100%;
        }

        :root {
            --linker-width: 4px;
            --unit: 0.1px;
            --flow-content-padding: 60px;
            --flow-item-padding: 60px;
            --max-item-height: 200px;
            --def-width: calc(100vh/400 * 200);
            --linker-overlap: 16px;
            --mini-padding-unit: 4px;

            --tentative-color: 200, 200, 200;
            --link-color: rgb(126, 215, 197);
            
            --main-accent: rgb(232, 111, 157);
            --main-accent-light: rgb(235, 179, 201);
            --padding-unit: 16px;
            --t-menu-padding: 4px;
            --t-menu-item-size: 40px;
            --accent-pink: rgb(204, 161, 234);
            --main-white-color: rgb(230,230,230);
            --current-ocean-color: ;
        }
        .flow-stack {
            background-color: rgba(220,220,220);
            width: fit-content;
            height: fit-content;
            padding: var(--mini-padding-unit);
            overflow: hidden;
            border-radius: 9px;
        }

        .flow-stack-item {
            background: var(--main-accent);
            display: inline-block;
            margin: var(--mini-padding-unit);
            padding: var(--mini-padding-unit);
            overflow: hidden;
            border-radius: 8px;
        }

        .flow-label {
            border-radius:5%; 
            width: fit-content;
            font-size: 1.5em;
            color: var(--main-white-color);
        }
    </style>
    <script type="module">
        import { pipeline } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1/dist/transformers.min.js";

        // ミニLMモデルの読み込み (初回はCDNからダウンロードされる)
        const pipe = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2');

        const segmenter = new TinySegmenter();
        const searchBoxForm = document.getElementById("searchbox-form");
        const searchBox = document.getElementById("searchbox");
        

        /*もしかしたら今後AIの登場でスペース区切りの検索に慣れてない人も出てくるかもなので分かち書きに変換したうえで分割する*/
        
        const candidate = await Promise.all([
            ["海と人の暗い雰囲気の絵", "pic/tochu.jpg"],
            ["キャラクター CG 3Dモデル 写真", "pic/imahe2.png"],
        ].map(async(v)=>[...v, (await pipe(v[0], {pooling: 'mean', normalize: true})).data]));
        
        searchBoxForm.addEventListener('submit', (e)=>{
            e.preventDefault();
            (async()=>{
                const output = await pipe(searchBox.value, { pooling: 'mean', normalize: true });
                console.log(output.data);
                //const splitted = searchBox.value.split(/\s/).reduce((res,v)=>[...segmenter.segment(v), ...res],[]);
                let target = candidate.map(c=>[c[0],c[1],getCosineWithouNormalize(c[2],output.data)])
                target.sort((a,b)=>b[2] - a[2]);
                console.log(target);
            })();
        });

        function getCosineWithouNormalize(a, b) {
            //console.log(a.reduce((res,v,i)=>res + v*b[i],0))
            return a.reduce((res,v,i)=>res + v*b[i],0);
        }

        function getCosine(a, b) {
            return a.reduce((res,v,i)=>res + v*b[i],0)/(
                a.reduce((res,v)=>res+v**2,0)**0.5 * b.reduce((res,v)=>res+v**2,0)**0.5
            );
        }
    </script>
</body>
</html>